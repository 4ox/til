
-- 투표율 ( ELECTION_TP_RATE_PER_SD )
CREATE OR REPLACE FORCE EDITIONABLE VIEW "INTERDEV"."ELECTION_TP_RATE_PER_SD" ("SD_ID", "SD_NAME", "TP_RATE", "TP_COUNT") AS 
  SELECT X.WWH_ID AS SD_ID, Y.SD_NAME AS SD_NAME, TO_CHAR( NVL(Y.TP_RATE,0),'FM990.0') AS TP_RATE, NVL(Y.TP_COUNT,0) AS TP_COUNT
	FROM 
	( SELECT '0000' AS WWH_ID FROM DUAL UNION SELECT TO_CHAR(WWH_ID) FROM ELECTION_CODE_WWH WHERE WWH_PARENT = 1 ) X
	LEFT OUTER JOIN (
		SELECT 
			'0000' AS SD_ID, 
			'전국' AS SD_NAME, 
			ROUND((TOTAL_COUNT / SGI_COUNT) * 100, 2) AS TP_RATE,
			TOTAL_COUNT AS TP_COUNT
		FROM (
			SELECT 
				SUM(TS.TOTAL_COUNT) AS TOTAL_COUNT,
				SUM(CS.SGI_COUNT) SGI_COUNT
			FROM ELECTION_TP_STATUS TS, ELECTION_CODE_SGIS CS
			WHERE TS.WWH_ID = CS.WWH_ID
			AND TS.INPUT_TIME = ( SELECT MAX(INPUT_TIME) FROM ELECTION_TP_STATUS)
			AND TS.SG_ID = '120170509'
		)
		UNION
		SELECT 
			X.SD_ID,
			W.WWH_NAME AS SD_NAME, 
			ROUND((TOTAL_COUNT / SGI_COUNT) * 100, 2) AS TP_RATE,
			TOTAL_COUNT AS TP_COUNT
		FROM (
			SELECT 
				SUBSTR(TS.WWH_ID,0,2) || '00' AS SD_ID,
				SUM(TS.TOTAL_COUNT) TOTAL_COUNT,
				SUM(CS.SGI_COUNT) SGI_COUNT
			FROM ELECTION_TP_STATUS TS, ELECTION_CODE_SGIS CS
			WHERE TS.WWH_ID = CS.WWH_ID
			AND TS.INPUT_TIME = ( SELECT MAX(INPUT_TIME) FROM ELECTION_TP_STATUS WHERE SG_ID = '120170509')
			AND TS.SG_ID = '120170509'
			GROUP BY SUBSTR(TS.WWH_ID,0,2)
		) X, ELECTION_CODE_WWH W
		WHERE X.SD_ID = W.WWH_ID
		ORDER BY SD_ID
	) Y
	ON X.WWH_ID = Y.SD_ID
	ORDER BY SD_ID;

-- 개표마감여부 ( ELECTION_GP_FINISHED )
SELECT
	'0000' AS WWH_ID, '전국' AS WWH_NAME, 0 AS WWH_ORDER, 0 AS WWH_PARENT
	, DECODE(COUNT(GI.CNT),0,'N','Y') AS FINISHED
FROM 
	( SELECT COUNT(WWH_ID) AS CNT FROM ELECTION_GP_INFO WHERE SG_ID = '120170509' ) GI, 
	( SELECT COUNT(DISTINCT(WWH_ID)) AS CNT FROM ELECTION_GP_FINISH WHERE SG_ID = '120170509' AND FINISH_TIME IS NOT NULL ) GF
WHERE GI.CNT = GF.CNT
UNION
SELECT 
	TO_CHAR(W.WWH_ID), WWH_NAME, WWH_ORDER, WWH_PARENT
	,(
		SELECT DECODE(COUNT(GI.CNT),0,'N','Y') AS FINISHED
		FROM 
			( SELECT COUNT(WWH_ID) AS CNT FROM ELECTION_GP_INFO WHERE SG_ID = '120170509' AND WWH_ID LIKE SUBSTR(W.WWH_ID,0,2) || '%' ) GI, 
			( SELECT COUNT(DISTINCT(WWH_ID)) AS CNT FROM ELECTION_GP_FINISH WHERE SG_ID = '120170509' AND FINISH_TIME IS NOT NULL AND WWH_ID LIKE SUBSTR(W.WWH_ID,0,2) || '%') GF
		WHERE GI.CNT = GF.CNT
	) AS FINISHED
FROM ELECTION_CODE_WWH W 
WHERE W.WWH_PARENT = 1
UNION
SELECT 
	TO_CHAR(W.WWH_ID), WWH_NAME, WWH_ORDER, WWH_PARENT
	,(
		SELECT DECODE(COUNT(GI.CNT),0,'N','Y') AS FINISHED
		FROM 
			( SELECT COUNT(WWH_ID) AS CNT FROM ELECTION_GP_INFO WHERE SG_ID = '120170509' AND WWH_ID = W.WWH_ID ) GI, 
			( SELECT COUNT(DISTINCT(WWH_ID)) AS CNT FROM ELECTION_GP_FINISH WHERE SG_ID = '120170509' AND WWH_ID = W.WWH_ID AND FINISH_TIME IS NOT NULL ) GF
		WHERE GI.CNT = GF.CNT
	) AS FINISHED
FROM ELECTION_CODE_WWH W 
WHERE W.WWH_PARENT != 1



-- 개표마감여부
SELECT X.WWH_ID, X.FINISHED
FROM 
(
	SELECT
		'0000' AS WWH_ID, '전국' AS WWH_NAME, 0 AS WWH_ORDER, 0 AS WWH_PARENT
		, DECODE(COUNT(GI.CNT),0,'N','Y') AS FINISHED
	FROM 
		( SELECT COUNT(WWH_ID) AS CNT FROM ELECTION_GP_INFO WHERE SG_ID = '120170509' ) GI, 
		( SELECT COUNT(DISTINCT(WWH_ID)) AS CNT FROM ELECTION_GP_FINISH WHERE SG_ID = '120170509' AND FINISH_TIME IS NOT NULL ) GF
	WHERE GI.CNT = GF.CNT
	UNION
	SELECT 
		TO_CHAR(W.WWH_ID), WWH_NAME, WWH_ORDER, WWH_PARENT
		,(
			SELECT DECODE(COUNT(GI.CNT),0,'N','Y') AS FINISHED
			FROM 
				( SELECT COUNT(WWH_ID) AS CNT FROM ELECTION_GP_INFO WHERE SG_ID = '120170509' AND WWH_ID LIKE SUBSTR(W.WWH_ID,0,2) || '%' ) GI, 
				( SELECT COUNT(DISTINCT(WWH_ID)) AS CNT FROM ELECTION_GP_FINISH WHERE SG_ID = '120170509' AND FINISH_TIME IS NOT NULL AND WWH_ID LIKE SUBSTR(W.WWH_ID,0,2) || '%') GF
			WHERE GI.CNT = GF.CNT
		) AS FINISHED
	FROM ELECTION_CODE_WWH W 
	WHERE W.WWH_PARENT = 1
	UNION
	SELECT 
		TO_CHAR(W.WWH_ID), WWH_NAME, WWH_ORDER, WWH_PARENT
		,(
			SELECT DECODE(COUNT(GI.CNT),0,'N','Y') AS FINISHED
			FROM 
				( SELECT COUNT(WWH_ID) AS CNT FROM ELECTION_GP_INFO WHERE SG_ID = '120170509' AND WWH_ID = W.WWH_ID ) GI, 
				( SELECT COUNT(DISTINCT(WWH_ID)) AS CNT FROM ELECTION_GP_FINISH WHERE SG_ID = '120170509' AND WWH_ID = W.WWH_ID AND FINISH_TIME IS NOT NULL ) GF
			WHERE GI.CNT = GF.CNT
		) AS FINISHED
	FROM ELECTION_CODE_WWH W 
	WHERE W.WWH_PARENT != 1
) X

-- 개표율 ( ELECTION_GP_RATE )
SELECT X.WWH_ID, X.GP_RATE
FROM (
	SELECT 
		Z.WWH_ID
		, Z.GP_RATE 
	FROM (
		SELECT '0000' AS WWH_ID, ROUND( SUM(GI.TP_COUNT) / SUM(TS.TOTAL_COUNT) * 100, 2 ) AS GP_RATE
		FROM ELECTION_GP_INFO GI, ELECTION_TP_STATUS TS
		WHERE GI.WWH_ID = TS.WWH_ID 
		AND TS.INPUT_TIME = (SELECT MAX(INPUT_TIME) FROM ELECTION_TP_STATUS )
		AND TS.SG_ID = '120170509'	
	) Z
	UNION 
	SELECT 
		X.SD_ID AS WWH_ID
		, X.GP_RATE
	FROM (
		SELECT TO_CHAR(GI.SD_ID) AS SD_ID, ROUND( SUM(GI.TP_COUNT) / SUM(TS.TOTAL_COUNT) * 100, 2 ) AS GP_RATE
		FROM ELECTION_GP_INFO GI, ELECTION_TP_STATUS TS
		WHERE GI.WWH_ID = TS.WWH_ID 
		AND TS.INPUT_TIME = (SELECT MAX(INPUT_TIME) FROM ELECTION_TP_STATUS )
		AND TS.SG_ID = '120170509'
		GROUP BY GI.SD_ID
	) X
	UNION
	SELECT 
		TO_CHAR(GI.WWH_ID) AS WWH_ID
		, ROUND((GI.TP_COUNT / TS.TOTAL_COUNT * 100),2) AS GP_RATE
	FROM 
		ELECTION_GP_INFO GI
		, ELECTION_TP_STATUS TS 
		LEFT OUTER JOIN
		(
			SELECT GF.WWH_ID, MIN(FINISH_TIME) AS FINISH_TIME
			FROM ELECTION_GP_FINISH GF
			WHERE GF.SG_ID = '120170509'
			GROUP BY GF.WWH_ID
		) Y
		ON TS.WWH_ID = Y.WWH_ID
	WHERE GI.WWH_ID = TS.WWH_ID 
	AND TS.INPUT_TIME = (SELECT MAX(INPUT_TIME) FROM ELECTION_TP_STATUS )
	AND TS.SG_ID = '120170509'
) X



-- 시도별 득표율 ( ELECTION_DP_RATE_PER_SD )
SELECT
	A.SD_ID
	, A.SD_NAME
	, C.GIHO
	, A.HBJ_NAME
	, A.DP_COUNT
	, A.DP_RATE
FROM 
(
	SELECT 
		'0000' SD_ID,
		'전국' SD_NAME,
		A.HBJ_NAME,
		DP_COUNT,
		TO_CHAR ( NVL ( TRUNC ( ( (DP_COUNT / DECODE (TOTAL, 0, NULL, TOTAL)) * 100), 2), 0), 'FM90.00') DP_RATE
	FROM 
	(  
		SELECT HBJ_NAME, SUM (DP_COUNT) DP_COUNT
		FROM ELECTION_GP_FIGHT
		WHERE SG_ID = '120170509'
	 	GROUP BY HBJ_NAME
	) A
	, (
		SELECT SUM (DP_COUNT) TOTAL
	    FROM ELECTION_GP_FIGHT
		WHERE SG_ID = '120170509'
	) B
	UNION 
	SELECT 
	 	A.SD_ID || '' SD_ID,
		WWH_NAME AS SD_NAME,
		HBJ_NAME,
		DP_COUNT,
		TO_CHAR ( NVL ( TRUNC ( ( ( DP_COUNT / DECODE(TOTAL, 0, NULL, TOTAL)) * 100), 2), 0), 'FM90.00') AS DP_RATE
	FROM 
	(  
		SELECT SD_ID, HBJ_NAME, SUM (DP_COUNT) DP_COUNT
		FROM ELECTION_GP_FIGHT
		WHERE SG_ID = '120170509'
	 	GROUP BY SD_ID, HBJ_NAME
	 ) A
	, ( 
		SELECT WWH_ID, WWH_NAME FROM ELECTION_CODE_WWH
	) B
	, ( 
		SELECT SD_ID, SUM (DP_COUNT) TOTAL
	    FROM ELECTION_GP_FIGHT
	    WHERE SG_ID = '120170509'
	    GROUP BY SD_ID
	) C
	WHERE A.SD_ID = B.WWH_ID AND A.SD_ID = C.SD_ID
) A
, (
	SELECT GIHO, NAME
    FROM ELECTION_CODE_HBJ
    WHERE STATUS = 2 AND GIHO <= 5
) C
 WHERE A.HBJ_NAME = C.NAME
 ORDER BY SD_ID, GIHO


 -- 시군구별 득표율 (ELECTION_DP_RATE_PER_WWH)
 SELECT
	TO_CHAR(A.WWH_ID)
	, A.WWH_NAME
	, C.GIHO
	, A.HBJ_NAME
	, A.DP_COUNT
	, A.DP_RATE
FROM 
(
	SELECT 
	 	A.WWH_ID,
		WWH_NAME,
		HBJ_NAME,
		DP_COUNT,
		TO_CHAR ( NVL ( TRUNC ( ( ( DP_COUNT / DECODE(TOTAL, 0, NULL, TOTAL)) * 100), 2), 0), 'FM90.00') AS DP_RATE
	FROM 
	(  
		SELECT WWH_ID, HBJ_NAME, SUM (DP_COUNT) DP_COUNT
		FROM ELECTION_GP_FIGHT
		WHERE SG_ID = '120170509'
	 	GROUP BY WWH_ID, HBJ_NAME
	 ) A
	, ( 
		SELECT WWH_ID, WWH_NAME FROM ELECTION_CODE_WWH
	) B
	, ( 
		SELECT WWH_ID, SUM (DP_COUNT) TOTAL
	    FROM ELECTION_GP_FIGHT
	    WHERE SG_ID = '120170509'
	    GROUP BY WWH_ID
	) C
	WHERE A.WWH_ID = B.WWH_ID AND A.WWH_ID = C.WWH_ID
) A
, (
	SELECT GIHO, NAME
    FROM ELECTION_CODE_HBJ
    WHERE STATUS = 2 AND GIHO <= 5
) C
 WHERE A.HBJ_NAME = C.NAME
 ORDER BY WWH_ID, GIHO



 


-- 시도별 득표율 ( ELECTION_DP_RATE_PER_SD )
SELECT
	A. WWH_ID
	, A.WWH_NAME
	, C.GIHO
	, A.HBJ_NAME
	, A.DP_COUNT
	, A.DP_RATE
FROM 
(
	SELECT 
		'0000' AS WWH_ID,
		'전국' AS WWH_NAME,
		A.HBJ_NAME,
		DP_COUNT,
		TO_CHAR ( NVL ( TRUNC ( ( (DP_COUNT / DECODE (TOTAL, 0, NULL, TOTAL)) * 100), 2), 0), 'FM90.00') DP_RATE
	FROM 
	(  
		SELECT HBJ_NAME, SUM (DP_COUNT) DP_COUNT
		FROM ELECTION_GP_FIGHT
		WHERE SG_ID = '120170509'
	 	GROUP BY HBJ_NAME
	) A
	, (
		SELECT SUM (DP_COUNT) TOTAL
	    FROM ELECTION_GP_FIGHT
		WHERE SG_ID = '120170509'
	) B
	UNION 
	SELECT 
	 	TO_CHAR(A.SD_ID) AS WWH_ID,
		WWH_NAME,
		HBJ_NAME,
		DP_COUNT,
		TO_CHAR ( NVL ( TRUNC ( ( ( DP_COUNT / DECODE(TOTAL, 0, NULL, TOTAL)) * 100), 2), 0), 'FM90.00') AS DP_RATE
	FROM 
	(  
		SELECT SD_ID, HBJ_NAME, SUM (DP_COUNT) DP_COUNT
		FROM ELECTION_GP_FIGHT
		WHERE SG_ID = '120170509'
	 	GROUP BY SD_ID, HBJ_NAME
	 ) A
	, ( 
		SELECT WWH_ID, WWH_NAME FROM ELECTION_CODE_WWH
	) B
	, ( 
		SELECT SD_ID, SUM (DP_COUNT) TOTAL
	    FROM ELECTION_GP_FIGHT
	    WHERE SG_ID = '120170509'
	    GROUP BY SD_ID
	) C
	WHERE A.SD_ID = B.WWH_ID AND A.SD_ID = C.SD_ID
) A
, (
	SELECT GIHO, NAME
    FROM ELECTION_CODE_HBJ
    WHERE STATUS = 2 AND GIHO <= 5
) C
 WHERE A.HBJ_NAME = C.NAME
 ORDER BY WWH_ID, GIHO



 -- 시군구별 득표율
SELECT
	TO_CHAR(A.WWH_ID) AS WWH_ID
	, A.WWH_NAME
	, C.GIHO
	, A.HBJ_NAME
	, A.DP_COUNT
	, A.DP_RATE
FROM 
(
	SELECT 
	 	A.WWH_ID,
		WWH_NAME,
		HBJ_NAME,
		DP_COUNT,
		TO_CHAR ( NVL ( TRUNC ( ( ( DP_COUNT / DECODE(TOTAL, 0, NULL, TOTAL)) * 100), 2), 0), 'FM90.00') AS DP_RATE
	FROM 
	(  
		SELECT WWH_ID, HBJ_NAME, SUM (DP_COUNT) DP_COUNT
		FROM ELECTION_GP_FIGHT
		WHERE SG_ID = '120170509'
	 	GROUP BY WWH_ID, HBJ_NAME
	 ) A
	, ( 
		SELECT WWH_ID, WWH_NAME FROM ELECTION_CODE_WWH
	) B
	, ( 
		SELECT WWH_ID, SUM (DP_COUNT) TOTAL
	    FROM ELECTION_GP_FIGHT
	    WHERE SG_ID = '120170509'
	    GROUP BY WWH_ID
	) C
	WHERE A.WWH_ID = B.WWH_ID AND A.WWH_ID = C.WWH_ID
) A
, (
	SELECT GIHO, NAME
    FROM ELECTION_CODE_HBJ
    WHERE STATUS = 2 AND GIHO <= 5
) C
 WHERE A.HBJ_NAME = C.NAME
 ORDER BY WWH_ID, GIHO